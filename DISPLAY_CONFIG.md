# ‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–∏—Å–ø–ª–µ—é

## üîò –ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥–∏—Å–ø–ª–µ—î–º –∫–Ω–æ–ø–∫–∞–º–∏

LILYGO T-Display –º–∞—î **2 –∫–Ω–æ–ø–∫–∏**:

| –ö–Ω–æ–ø–∫–∞ | GPIO | –†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è | –§—É–Ω–∫—Ü—ñ—è |
|--------|------|--------------|---------|
| Button 1 | 35 | –í–µ—Ä—Ö–Ω—è (–ø—Ä–∞–≤–∞) | –£–≤—ñ–º–∫–Ω—É—Ç–∏ –¥–∏—Å–ø–ª–µ–π |
| Button 2 | 0 | –ù–∏–∂–Ω—è (Boot) | –£–≤—ñ–º–∫–Ω—É—Ç–∏ –¥–∏—Å–ø–ª–µ–π |

### –Ø–∫ –ø—Ä–∞—Ü—é—î:

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è**
   - –î–∏—Å–ø–ª–µ–π –≤–∏–º–∏–∫–∞—î—Ç—å—Å—è —á–µ—Ä–µ–∑ **10 —Å–µ–∫—É–Ω–¥** –ø—ñ—Å–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
   - –ï–∫–æ–Ω–æ–º–∏—Ç—å –µ–Ω–µ—Ä–≥—ñ—é —Ç–∞ –ø—Ä–æ–¥–æ–≤–∂—É—î —Ç–µ—Ä–º—ñ–Ω —Å–ª—É–∂–±–∏ –¥–∏—Å–ø–ª–µ—é
   - –ó–º–µ–Ω—à—É—î —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –∑ ~120mA –¥–æ ~80mA

2. **–£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è**
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **–±—É–¥—å-—è–∫—É –∫–Ω–æ–ø–∫—É** —â–æ–± —É–≤—ñ–º–∫–Ω—É—Ç–∏ –¥–∏—Å–ø–ª–µ–π
   - –î–∏—Å–ø–ª–µ–π –∑–∞–ª–∏—à–∏—Ç—å—Å—è —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º –ø—Ä–æ—Ç—è–≥–æ–º **10 —Å–µ–∫—É–Ω–¥**
   - –ö–æ–∂–Ω–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è **–ø–æ–¥–æ–≤–∂—É—î** —á–∞—Å —Ä–æ–±–æ—Ç–∏ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥

3. **–í —Ä–µ–∂–∏–º—ñ —Å–Ω—É**
   - –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –¥–∏—Å–ø–ª–µ—é –≤–∏–º–∫–Ω–µ–Ω–∞ (TFT_BL = LOW)
   - –ï–∫—Ä–∞–Ω –æ—á–∏—â–µ–Ω–æ (—á–æ—Ä–Ω–∏–π)
   - ESP32 –ø—Ä–æ–¥–æ–≤–∂—É—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ (MQTT, BLE)
   - Home Assistant –æ—Ç—Ä–∏–º—É—î –¥–∞–Ω—ñ —è–∫ —ñ —Ä–∞–Ω—ñ—à–µ

---

## ‚è±Ô∏è –ó–º—ñ–Ω–∞ —Ç–∞–π–º–∞—É—Ç—É –¥–∏—Å–ø–ª–µ—é

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º: **10 —Å–µ–∫—É–Ω–¥**

### –Ø–∫ –∑–º—ñ–Ω–∏—Ç–∏:

–í—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ `include/display_manager.h`:

```cpp
// –ó–Ω–∞–π–¥—ñ—Ç—å —Ü–µ–π —Ä—è–¥–æ–∫:
const unsigned long displayTimeout = 10000; // 10 —Å–µ–∫—É–Ω–¥

// –ó–º—ñ–Ω—ñ—Ç—å –Ω–∞ –ø–æ—Ç—Ä—ñ–±–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è (–≤ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∞—Ö):
const unsigned long displayTimeout = 30000; // 30 —Å–µ–∫—É–Ω–¥
const unsigned long displayTimeout = 60000; // 1 —Ö–≤–∏–ª–∏–Ω–∞
const unsigned long displayTimeout = 5000;  // 5 —Å–µ–∫—É–Ω–¥
```

–ó–±–µ—Ä–µ–∂—ñ—Ç—å —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ:
```bash
make upload
```

---

## üîß –ó–∞–≤–∂–¥–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π –¥–∏—Å–ø–ª–µ–π

–Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ —â–æ–± –¥–∏—Å–ø–ª–µ–π **–Ω—ñ–∫–æ–ª–∏ –Ω–µ –≤–∏–º–∏–∫–∞–≤—Å—è**:

### –í–∞—Ä—ñ–∞–Ω—Ç 1: –í–µ–ª–∏–∫–∏–π —Ç–∞–π–º–∞—É—Ç

```cpp
// display_manager.h
const unsigned long displayTimeout = 4294967295; // ~49 –¥–Ω—ñ–≤ (–º–∞–∫—Å–∏–º—É–º unsigned long)
```

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –í–∏–º–∫–Ω—É—Ç–∏ –∞–≤—Ç–æ–≤–∏–º–∫–Ω–µ–Ω–Ω—è

–í `src/display_manager.cpp`, —Ñ—É–Ω–∫—Ü—ñ—è `update()`:

```cpp
void DisplayManager::update() {
    // –û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–æ–∫
    handleButtons();
    
    // –ó–ê–ö–û–ú–ï–ù–¢–£–ô–¢–ï –¶–Ü –†–Ø–î–ö–ò:
    // if (displayOn && (millis() - lastActivity > displayTimeout)) {
    //     turnDisplayOff();
    // }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∏—Å–ø–ª–µ—é
    if (bluetti && bluetti->isConnected()) {
        showStatus();
    }
}
```

‚ö†Ô∏è **–£–≤–∞–≥–∞:** –ü–æ—Å—Ç—ñ–π–Ω–æ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π –¥–∏—Å–ø–ª–µ–π:
- –ó–±—ñ–ª—å—à—É—î —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –µ–Ω–µ—Ä–≥—ñ—ó (~40mA –¥–æ–¥–∞—Ç–∫–æ–≤–æ)
- –°–∫–æ—Ä–æ—á—É—î —Ç–µ—Ä–º—ñ–Ω —Å–ª—É–∂–±–∏ –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏
- –ú–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –≤–∏–≥–æ—Ä—è–Ω–Ω—è –ø—ñ–∫—Å–µ–ª

---

## üé® –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ

### PWM –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Å–≤—ñ—Ç–∫–æ—é

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –≤–º–∏–∫–∞—î—Ç—å—Å—è –Ω–∞ 100%. –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ PWM:

```cpp
// display_manager.cpp

void DisplayManager::begin() {
    tft.init();
    tft.setRotation(1);
    
    // –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ PWM –¥–ª—è –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏
    ledcSetup(0, 5000, 8);        // –∫–∞–Ω–∞–ª 0, 5kHz, 8-bit
    ledcAttachPin(TFT_BL, 0);     // –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –¥–æ TFT_BL
    ledcWrite(0, 255);             // 100% —è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å (0-255)
}

void DisplayManager::turnDisplayOn() {
    ledcWrite(0, 255);  // 100%
    displayOn = true;
    lastActivity = millis();
}

void DisplayManager::turnDisplayOff() {
    ledcWrite(0, 0);    // 0%
    tft.fillScreen(TFT_BLACK);
    displayOn = false;
}
```

–î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é –∑–º—ñ–Ω–∏ —è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ:

```cpp
// display_manager.h
void setBrightness(uint8_t level); // 0-255

// display_manager.cpp
void DisplayManager::setBrightness(uint8_t level) {
    ledcWrite(0, level);
}
```

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
```cpp
display->setBrightness(128); // 50% —è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ
display->setBrightness(64);  // 25% —è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ
```

---

## üåô –ù—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º–µ–Ω—à—É–≤–∞—Ç–∏ —è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å –≤–Ω–æ—á—ñ:

```cpp
void DisplayManager::update() {
    handleButtons();
    
    // –ù—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º (22:00 - 7:00)
    time_t now;
    struct tm timeinfo;
    time(&now);
    localtime_r(&now, &timeinfo);
    int hour = timeinfo.tm_hour;
    
    if (hour >= 22 || hour < 7) {
        ledcWrite(0, 64);  // 25% –≤–Ω–æ—á—ñ
    } else {
        ledcWrite(0, 255); // 100% –≤–¥–µ–Ω—å
    }
    
    // –†–µ—à—Ç–∞ –∫–æ–¥—É...
}
```

---

## üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞–Ω—É –¥–∏—Å–ø–ª–µ—é

### –ß–µ—Ä–µ–∑ Serial Monitor

```cpp
// –í–∂–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥—ñ
Display ON
Display OFF (sleep mode)
```

### –ß–µ—Ä–µ–∑ MQTT

–î–æ–¥–∞—Ç–∏ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é —Å—Ç–∞–Ω—É –¥–∏—Å–ø–ª–µ—é:

```cpp
// mqtt_handler.cpp
void MQTTHandler::publishStatus() {
    // ... —ñ—Å–Ω—É—é—á–∏–π –∫–æ–¥ ...
    
    // –î–æ–¥–∞—Ç–∏ —Å—Ç–∞–Ω –¥–∏—Å–ø–ª–µ—é
    mqttClient.publish("homeassistant/bluetti/eb3a/display/state", 
                      display->isDisplayOn() ? "ON" : "OFF", true);
}
```

–í Home Assistant –∑'—è–≤–∏—Ç—å—Å—è entity:
- `sensor.bluetti_eb3a_display` - —Å—Ç–∞–Ω –¥–∏—Å–ø–ª–µ—é

---

## üîã –°–ø–æ–∂–∏–≤–∞–Ω–Ω—è –µ–Ω–µ—Ä–≥—ñ—ó

| –†–µ–∂–∏–º | –°–ø–æ–∂–∏–≤–∞–Ω–Ω—è | –ü—Ä–∏–º—ñ—Ç–∫–∞ |
|-------|-----------|----------|
| –î–∏—Å–ø–ª–µ–π ON | ~120mA | WiFi + BLE + Display |
| –î–∏—Å–ø–ª–µ–π OFF | ~80mA | WiFi + BLE |
| Deep Sleep | ~5mA | –ù–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤ —Ü—ñ–π –≤–µ—Ä—Å—ñ—ó |

**–ï–∫–æ–Ω–æ–º—ñ—è:** ~40mA –ø—Ä–∏ –≤–∏–º–∫–Ω–µ–Ω–æ–º—É –¥–∏—Å–ø–ª–µ—ó

**–ó–∞ –¥–æ–±—É:**
- –î–∏—Å–ø–ª–µ–π –∑–∞–≤–∂–¥–∏ ON: 120mA √ó 24h = 2880 mAh
- –î–∏—Å–ø–ª–µ–π 10% —á–∞—Å—É: 80mA √ó 24h + 40mA √ó 2.4h = 2016 mAh
- **–ï–∫–æ–Ω–æ–º—ñ—è: ~864 mAh/–¥–µ–Ω—å (~30%)**

---

## üéÆ –†–æ–∑—à–∏—Ä–µ–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∫–Ω–æ–ø–æ–∫

### –î–æ–¥–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –∫–Ω–æ–ø–æ–∫

```cpp
void DisplayManager::handleButtons() {
    bool btn1 = !digitalRead(BUTTON_1);
    bool btn2 = !digitalRead(BUTTON_2);
    
    // –ö–Ω–æ–ø–∫–∞ 1 - —É–≤—ñ–º–∫–Ω—É—Ç–∏ –¥–∏—Å–ø–ª–µ–π
    if (btn1 && !button1Pressed) {
        wakeDisplay();
        button1Pressed = true;
    } else if (!btn1) {
        button1Pressed = false;
    }
    
    // –ö–Ω–æ–ø–∫–∞ 2 - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ AC –≤–∏—Ö—ñ–¥
    if (btn2 && !button2Pressed) {
        if (!displayOn) {
            wakeDisplay();
        } else {
            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏ AC
            bool acState = bluetti->getACOutputState();
            bluetti->setACOutput(!acState);
            Serial.printf("AC Output: %s\n", !acState ? "ON" : "OFF");
        }
        button2Pressed = true;
    } else if (!btn2) {
        button2Pressed = false;
    }
}
```

### –î–æ–≤–≥–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è

```cpp
unsigned long button1PressTime = 0;
const unsigned long longPressTime = 2000; // 2 —Å–µ–∫—É–Ω–¥–∏

void DisplayManager::handleButtons() {
    bool btn1 = !digitalRead(BUTTON_1);
    
    if (btn1 && !button1Pressed) {
        button1PressTime = millis();
        button1Pressed = true;
    } else if (btn1 && button1Pressed) {
        // –î–æ–≤–≥–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
        if (millis() - button1PressTime > longPressTime) {
            // –í–∏–∫–æ–Ω–∞—Ç–∏ —è–∫—É—Å—å –¥—ñ—é
            Serial.println("Long press detected!");
            button1PressTime = millis(); // –ó–∞–ø–æ–±—ñ–≥—Ç–∏ –ø–æ–≤—Ç–æ—Ä–∞–º
        }
    } else if (!btn1) {
        if (button1Pressed && (millis() - button1PressTime < longPressTime)) {
            // –ö–æ—Ä–æ—Ç–∫–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è
            wakeDisplay();
        }
        button1Pressed = false;
    }
}
```

---

## üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### 1. –®–≤–∏–¥–∫–∏–π –ø–µ—Ä–µ–≥–ª—è–¥ —Å—Ç–∞—Ç—É—Å—É
–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ‚Üí –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å ‚Üí –¥–∏—Å–ø–ª–µ–π –≤–∏–º–∫–Ω–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

### 2. –ü–æ—Å—Ç—ñ–π–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
–ù–∞—Ç–∏—Å–∫–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥ —â–æ–± –ø–æ–¥–æ–≤–∂–∏—Ç–∏ —á–∞—Å —Ä–æ–±–æ—Ç–∏

### 3. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è
–ó–±—ñ–ª—å—à—Ç–µ —Ç–∞–π–º–∞—É—Ç –¥–æ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó

### 4. –ï–∫–æ–Ω–æ–º–Ω–∏–π —Ä–µ–∂–∏–º
–ó–º–µ–Ω—à—ñ—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–æ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó –µ–∫–æ–Ω–æ–º—ñ—ó

---

## üêõ –£—Å—É–Ω–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º

### –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ä–µ–∞–≥—É—é—Ç—å

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ (GPIO 35 —Ç–∞ 0)
2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ `INPUT_PULLUP` –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
3. –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –ª–æ–≥–∏ Serial Monitor

### –î–∏—Å–ø–ª–µ–π –Ω–µ –≤–∏–º–∏–∫–∞—î—Ç—å—Å—è

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ `displayTimeout` –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ —É–º–æ–≤–∞ –≤ `update()` –Ω–µ –∑–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–∞
3. –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ ESP32

### –î–∏—Å–ø–ª–µ–π –º–∏–≥–∞—î

1. –ó–±—ñ–ª—å—à—Ç–µ `displayTimeout`
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –∫–Ω–æ–ø–∫–∏ –Ω–µ –∑–∞–ª–∏–ø–∞—é—Ç—å
3. –î–æ–¥–∞–π—Ç–µ debounce –≤ –∫–æ–¥ –∫–Ω–æ–ø–æ–∫

---

**–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –¥–∏—Å–ø–ª–µ–π –ø—ñ–¥ —Å–≤–æ—ó –ø–æ—Ç—Ä–µ–±–∏!** üé®
