# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Ä–µ–∂–∏–º—É –∑–∞—Ä—è–¥–∫–∏ Bluetti

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–µ–∂–∏–º—É –∑–∞—Ä—è–¥–∫–∏ ESP32 –Ω–µ –≤—ñ–¥—Å—Ç–µ–∂—É–≤–∞–ª–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º —ñ –ø—Ä–∏ –≤–º–∏–∫–∞–Ω–Ω—ñ Turbo –≤–∏–º–∏–∫–∞–≤—Å—è AC.

## –†—ñ—à–µ–Ω–Ω—è

### 1. –í–∏–¥–∞–ª–µ–Ω–æ –±–ª–æ–∫—É—é—á—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤ `setChargingSpeed()`
**–§–∞–π–ª:** `src/bluetti_device.cpp`

**–©–æ –±—É–ª–æ:**
```cpp
// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–º—ñ–Ω–æ—é —Ä–µ–∂–∏–º—É
// 1. –ë–∞—Ç–∞—Ä–µ—è –ø–æ–≤–Ω–∞ (>98%) - –Ω–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ä–µ–∂–∏–º
if (cachedBattery >= 98) {
  Serial.printf("[Bluetti] ‚ö†Ô∏è  Battery full (%d%%) - cannot change charging mode\n", cachedBattery);
  return false;
}

// 2. –°—Ç–∞–Ω—Ü—ñ—è –Ω–µ –∑–∞—Ä—è–¥–∂–∞—î—Ç—å—Å—è (AC Input < 100W)
if (status->acInputPower < 100) {
  Serial.printf("[Bluetti] ‚ö†Ô∏è  Not charging (AC Input: %dW < 100W)\n", status->acInputPower);
  return false;
}
```

**–©–æ —Å—Ç–∞–ª–æ:**
```cpp
Serial.printf("[Bluetti] üîã Setting charging mode: %s (%dW)\n", modeNames[speed], powerWatts[speed]);
```

**–ß–æ–º—É:** –¶—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–ª–æ–∫—É–≤–∞–ª–∏ –∑–º—ñ–Ω—É —Ä–µ–∂–∏–º—É –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ —Å—Ç–∞–Ω—Ü—ñ—è –±—É–ª–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞ –¥–æ –º–µ—Ä–µ–∂—ñ. Bluetti —Å–∞–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—é—î –∫–æ–ª–∏ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ä–µ–∂–∏–º.

---

### 2. –î–æ–¥–∞–Ω–æ –∑–∞–ø–∏—Ç –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏
**–§–∞–π–ª:** `src/bluetti_device.cpp`

**–©–æ –±—É–ª–æ:**
```cpp
if (success) {
  status->chargingSpeed = speed;
  Serial.printf("[Bluetti] ‚úÖ Charging mode: %s (%dW)\n", modeNames[speed], powerWatts[speed]);
}

return success;
```

**–©–æ —Å—Ç–∞–ª–æ:**
```cpp
if (success) {
  status->chargingSpeed = speed;
  Serial.printf("[Bluetti] ‚úÖ Charging mode: %s (%dW)\n", modeNames[speed], powerWatts[speed]);
  
  // –ó–∞–ø–∏—Ç—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º –∑–∞—Ä—è–¥–∫–∏ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
  delay(500);
  requestChargingMode();
}

return success;
```

**–ß–æ–º—É:** –ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥–∏ –∑–º—ñ–Ω–∏ —Ä–µ–∂–∏–º—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞—á–µ–∫–∞—Ç–∏ —ñ –∑–∞–ø–∏—Ç–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –∑ Bluetti –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.

---

### 3. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ `requestChargingMode()`
**–§–∞–π–ª:** `src/bluetti_device.cpp`

**–©–æ –±—É–ª–æ:**
```cpp
void BluettiDevice::requestChargingMode() {
  // ...
  writeCharacteristic->writeValue(cmd, sizeof(cmd), false);
}
```

**–©–æ —Å—Ç–∞–ª–æ:**
```cpp
void BluettiDevice::requestChargingMode() {
  // ...
  Serial.print("[Bluetti] Requesting charging mode from 0x0BBF... ");
  if (sendCommand(cmd, sizeof(cmd))) {
    Serial.println("‚úÖ");
  } else {
    Serial.println("‚ùå");
  }
}
```

**–ß–æ–º—É:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `sendCommand()` –∑–∞–±–µ–∑–ø–µ—á—É—î –ø—Ä–∞–≤–∏–ª—å–Ω—É –æ–±—Ä–æ–±–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —á–µ—Ä–µ–∑ `handleNotification()` –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º.

---

### 4. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
**–§–∞–π–ª:** `src/web_server.cpp`

**–©–æ –±—É–ª–æ:**
```javascript
fetch('/charging_speed', {...}).then(()=>location.reload());
```

**–©–æ —Å—Ç–∞–ª–æ:**
```javascript
fetch('/charging_speed', {...}).then(()=>setTimeout(u,1000));
```

**–ß–æ–º—É:** 
- `location.reload()` –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª–∞ –≤—Å—é —Å—Ç–æ—Ä—ñ–Ω–∫—É (–ø–æ–≤—ñ–ª—å–Ω–æ)
- `setTimeout(u,1000)` –æ–Ω–æ–≤–ª—é—î —Ç—ñ–ª—å–∫–∏ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É (—à–≤–∏–¥–∫–æ)
- –î–∞—î —á–∞—Å ESP32 –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥ Bluetti

---

## –Ø–∫ –ø—Ä–∞—Ü—é—î –∑–∞—Ä–∞–∑

### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –ø–æ–¥—ñ–π:
1. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É** —Ä–µ–∂–∏–º—É –∑–∞—Ä—è–¥–∫–∏ —É –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ
2. **ESP32 –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –∫–æ–º–∞–Ω–¥—É** –¥–æ Bluetti (—Ä–µ–≥—ñ—Å—Ç—Ä–∏ 0x0BBF —Ç–∞ 0x0BC0)
3. **Bluetti –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î** –∫–æ–º–∞–Ω–¥—É (notification –∑ —Ñ—É–Ω–∫—Ü—ñ—î—é 0x06)
4. **ESP32 —á–µ–∫–∞—î 500ms** —ñ –∑–∞–ø–∏—Ç—É—î –ø–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º (—Ä–µ–≥—ñ—Å—Ç—Ä 0x0BBF)
5. **Bluetti –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î** –∑ –ø–æ—Ç–æ—á–Ω–∏–º —Ä–µ–∂–∏–º–æ–º (notification 7 –±–∞–π—Ç—ñ–≤)
6. **ESP32 –æ–Ω–æ–≤–ª—é—î `status->chargingSpeed`**
7. **–í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è** —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É

### –ü—Ä–æ—Ç–æ–∫–æ–ª MODBUS:
```
–ó–∞–ø–∏—Ç —Ä–µ–∂–∏–º—É (0x0BBF):
01 03 0B BF 00 01 [CRC16]

–í—ñ–¥–ø–æ–≤—ñ–¥—å (Silent=1):
01 03 02 00 01 79 84
         ^^ ^^ - —Ä–µ–∂–∏–º (0=Standard, 1=Silent, 2=Turbo)
```

### –ó–º—ñ–Ω–∞ —Ä–µ–∂–∏–º—É (0x0BBF —ñ 0x0BC0):
```
–ó–∞–ø–∏—Å (Turbo=2):
01 06 0B BF 00 02 [CRC16]

–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è:
01 06 0B BF 00 02 3B CB
```

---

## –©–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ

‚úÖ **ESP32 —Ç–µ–ø–µ—Ä –≤—ñ–¥—Å—Ç–µ–∂—É—î –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º –∑–∞—Ä—è–¥–∫–∏**
- –ó–∞–ø–∏—Ç—É—î —Ä–µ–∂–∏–º –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- –ó–∞–ø–∏—Ç—É—î —Ä–µ–∂–∏–º –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –∫–æ–º–∞–Ω–¥–∏
- –û–Ω–æ–≤–ª—é—î `SystemStatus.chargingSpeed`

‚úÖ **–í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–∫–∞–∑—É—î —Ä–µ–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º**
- –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
- –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤—ñ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ (—á–µ—Ä–µ–∑ 1 —Å–µ–∫)
- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—É—î –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º

‚úÖ **–ó–º—ñ–Ω–∞ —Ä–µ–∂–∏–º—É –ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ**
- –í–∏–¥–∞–ª–µ–Ω–æ —Ö–∏–±–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- AC –Ω–µ –≤–∏–º–∏–∫–∞—î—Ç—å—Å—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ä–µ–∂–∏–º—É
- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ notification

‚úÖ **MQTT —Ç–∞–∫–æ–∂ –æ—Ç—Ä–∏–º—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è**
- `sensor.bluetti_charging_speed` (0/1/2)
- –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ `requestStatus()`

---

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É:
```
[Bluetti] Requesting charging mode from 0x0BBF... ‚úÖ
[Bluetti] üîã Current charging mode: Silent (1)
```

### 2. –ó–º—ñ–Ω–∞ —Ä–µ–∂–∏–º—É:
```
[Bluetti] üîã Setting charging mode: Turbo (350W)
[Bluetti] Writing 0x0BBF = 2... ‚úÖ
[Bluetti] Writing 0x0BC0 = 2... ‚úÖ
[Bluetti] ‚úÖ Charging mode: Turbo (350W)
[Bluetti] Requesting charging mode from 0x0BBF... ‚úÖ
[Bluetti] üîã Current charging mode: Turbo (2)
```

### 3. –í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
- –ü–æ–∫–∞–∑—É—î "Silent" –∞–±–æ "Standard" –∞–±–æ "Turbo"
- –ö–Ω–æ–ø–∫–∞ –∑ –µ–º–æ–¥–∑—ñ: üìä Standard, üîá Silent, ‚ö° Turbo
- –¶–∏–∫–ª—ñ—á–Ω–µ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è: Standard ‚Üí Silent ‚Üí Turbo ‚Üí Standard

---

## –§–∞–π–ª–∏ –∑–º—ñ–Ω–µ–Ω–æ

1. **src/bluetti_device.cpp:**
   - `setChargingSpeed()` - –≤–∏–¥–∞–ª–µ–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏, –¥–æ–¥–∞–Ω–æ `requestChargingMode()`
   - `requestChargingMode()` - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `sendCommand()` –∑ –ª–æ–≥—É–≤–∞–Ω–Ω—è–º

2. **src/web_server.cpp:**
   - JavaScript - –∑–∞–º—ñ–Ω–µ–Ω–æ `location.reload()` –Ω–∞ `setTimeout(u,1000)`
   - –ü–æ—Ä—è–¥–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: —Å–ø–æ—á–∞—Ç–∫—É `cs-text`, –ø–æ—Ç—ñ–º `cs-container`

---

## –ü—Ä–∏–º—ñ—Ç–∫–∏

### –†–µ–≥—ñ—Å—Ç—Ä–∏ Bluetti EB3A:
- **0x0BBF** - –†–µ–∂–∏–º –∑–∞—Ä—è–¥–∫–∏ AC (read/write)
- **0x0BC0** - –†–µ–∂–∏–º –∑–∞—Ä—è–¥–∫–∏ AC –∫–æ–ø—ñ—è (read/write)
- –û–±–∏–¥–≤–∞ —Ä–µ–≥—ñ—Å—Ç—Ä–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏

### –ó–Ω–∞—á–µ–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤:
- **0** = Standard (268W)
- **1** = Silent (100W)
- **2** = Turbo (350W)

### Notification types:
- **7 bytes** (01 03 02 ...) - –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ Read (1 —Ä–µ–≥—ñ—Å—Ç—Ä)
- **8 bytes** (01 06 ...) - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è Write
- **85 bytes** (01 03 50 ...) - –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ Read (40 —Ä–µ–≥—ñ—Å—Ç—Ä—ñ–≤)

---

## –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

–¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞:
- ‚úÖ –ó–º—ñ–Ω—é–≤–∞—Ç–∏ —Ä–µ–∂–∏–º –∑–∞—Ä—è–¥–∫–∏ –∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
- ‚úÖ –ó–º—ñ–Ω—é–≤–∞—Ç–∏ —Ä–µ–∂–∏–º —á–µ—Ä–µ–∑ MQTT
- ‚úÖ –ë–∞—á–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º —É –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ
- ‚úÖ –ë–∞—á–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–µ–∂–∏–º —É Home Assistant
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ –∑–º—ñ–Ω—É —Ä–µ–∂–∏–º—É —á–µ—Ä–µ–∑ HA

---

## –í—ñ–¥–æ–º—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è

1. **Bluetti –∫–æ–Ω—Ç—Ä–æ–ª—é—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–º—ñ–Ω–∏ —Ä–µ–∂–∏–º—É:**
   - –Ø–∫—â–æ –±–∞—Ç–∞—Ä–µ—è –ø–æ–≤–Ω–∞ (100%) - –∑–º—ñ–Ω–∞ –º–æ–∂–µ –Ω–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏—Å—è
   - –Ø–∫—â–æ –Ω–µ–º–∞—î AC –≤—Ö–æ–¥—É - —Ä–µ–∂–∏–º –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏, –∞–ª–µ –≤—ñ–Ω –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π

2. **–ó–º—ñ–Ω–∞ —Ä–µ–∂–∏–º—É –∑–∞–π–º–∞—î ~1 —Å–µ–∫—É–Ω–¥—É:**
   - –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥–∏: ~200ms
   - –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: ~300ms
   - –ó–∞–ø–∏—Ç –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É: ~500ms

3. **–†–µ–∂–∏–º –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É Bluetti:**
   - –ü—Ä–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ ESP32 —Ä–µ–∂–∏–º –Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è
   - –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É ESP32 –∑—á–∏—Ç—É—î –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º

---

–°—Ç–≤–æ—Ä–µ–Ω–æ: 8 –≥—Ä—É–¥–Ω—è 2025
