# üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –∑ –∞–¥–¥–æ–Ω—É "Bluetti to MQTT" –Ω–∞ ESP32

## ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –ö–æ–Ω—Ñ–ª—ñ–∫—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω—å

**Bluetti EB3A –ø—ñ–¥—Ç—Ä–∏–º—É—î –ª–∏—à–µ –û–î–ù–ï –∞–∫—Ç–∏–≤–Ω–µ BLE –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ!**

–Ø–∫—â–æ –∞–¥–¥–æ–Ω "Bluetti to MQTT" –ø—Ä–∞—Ü—é—î, ESP32 **–ù–ï –ó–ú–û–ñ–ï** –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ Bluetti.

---

## üìã –ü–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è

### 1Ô∏è‚É£ –í–∏–º–∫–Ω—É—Ç–∏ –∞–¥–¥–æ–Ω "Bluetti to MQTT"

**–í Home Assistant:**

1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å: **Settings** ‚Üí **Add-ons** ‚Üí **Bluetti to MQTT**
2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **STOP** (–∑—É–ø–∏–Ω–∏—Ç–∏)
3. (–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) –í–∏–º–∫–Ω—ñ—Ç—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫:
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Configuration**
   - –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å `auto_start: false` (—è–∫—â–æ —î —Ç–∞–∫–∞ –æ–ø—Ü—ñ—è)
   - –ê–±–æ –ø—Ä–æ—Å—Ç–æ **Uninstall** –∞–¥–¥–æ–Ω, —è–∫—â–æ –±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
- –í –ª–æ–≥–∞—Ö –∞–¥–¥–æ–Ω—É –º–∞—î –∑'—è–≤–∏—Ç–∏—Å—è: `Disconnected from clients`
- –ê–±–æ –∞–¥–¥–æ–Ω –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –≤–∏–º–∫–Ω–µ–Ω–∏–π

---

### 2Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ESP32

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ ESP32 –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**

#### –ß–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å ESP32:

1. –ü—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ WiFi –º–µ—Ä–µ–∂—ñ ESP32 (—è–∫—â–æ —î AP —Ä–µ–∂–∏–º)
2. –ê–±–æ –≤—ñ–¥–∫—Ä–∏–π—Ç–µ `http://<IP_ESP32>` –≤ –±—Ä–∞—É–∑–µ—Ä—ñ
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:
   - **MQTT Server:** IP –∞–¥—Ä–µ—Å–∞ Home Assistant (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `11.18.10.52`)
   - **Bluetti MAC:** `D1:4C:11:6B:6A:3D`
   - **WiFi SSID:** –í–∞—à–∞ WiFi –º–µ—Ä–µ–∂–∞
   - **WiFi Password:** –í–∞—à –ø–∞—Ä–æ–ª—å

#### –ê–±–æ —á–µ—Ä–µ–∑ Serial Monitor:

```bash
pio device monitor
```

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏:
```
Loaded MQTT server from Preferences: 11.18.10.52
Loaded Bluetti MAC from Preferences: D1:4C:11:6B:6A:3D
```

---

### 3Ô∏è‚É£ –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ entity –∑ Home Assistant

**–Ø–∫—â–æ –∞–¥–¥–æ–Ω —Å—Ç–≤–æ—Ä–∏–≤ entity, —ó—Ö –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–¥–∞–ª–∏—Ç–∏:**

1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å: **Settings** ‚Üí **Devices & Services** ‚Üí **MQTT**
2. –ó–Ω–∞–π–¥—ñ—Ç—å –ø—Ä–∏—Å—Ç—Ä—ñ–π **"Bluetti EB3A"** (—Å—Ç–≤–æ—Ä–µ–Ω–∏–π –∞–¥–¥–æ–Ω–æ–º)
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –ø—Ä–∏—Å—Ç—Ä—ñ–π ‚Üí **Delete**
4. –ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –≤–∏–¥–∞–ª–µ–Ω–Ω—è

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ (—á–µ—Ä–µ–∑ Developer Tools):**

1. **Developer Tools** ‚Üí **States**
2. –ó–Ω–∞–π–¥—ñ—Ç—å –≤—Å—ñ entity, —â–æ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ `sensor.bluetti_` –∞–±–æ `switch.bluetti_`
3. –í–∏–¥–∞–ª—ñ—Ç—å —ó—Ö –≤—Ä—É—á–Ω—É (–∞–±–æ –≤–æ–Ω–∏ –∑–Ω–∏–∫–Ω—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É)

---

### 4Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ ESP32

**–í–∞—Ä—ñ–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ Serial Monitor**
```bash
pio device monitor
# –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É RESET –Ω–∞ ESP32
```

**–í–∞—Ä—ñ–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å**
- –í—ñ–¥–∫—Ä–∏–π—Ç–µ `http://<IP_ESP32>`
- –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "Restart"

**–í–∞—Ä—ñ–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ OTA (—è–∫—â–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ)**
```bash
make ota IP=<IP_ESP32>
```

---

### 5Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ ESP32:**

```bash
pio device monitor
```

**–ú–∞—î –∑'—è–≤–∏—Ç–∏—Å—è:**
```
[Bluetti] Connecting to Bluetti D1:4C:11:6B:6A:3D...
[Bluetti] Connection confirmed in loop(), setting up characteristics...
[Bluetti] Successfully subscribed to notifications
[Bluetti] *** CALLBACK CALLED ***  ‚Üê –¶–ï –í–ê–ñ–õ–ò–í–û!
[Bluetti] *** NOTIFICATION RECEIVED ***
WiFi connected, IP: 11.18.10.55
MQTT connected!
Published state to MQTT: SUCCESS ‚úì
```

**–Ø–∫—â–æ –±–∞—á–∏—Ç–µ `*** CALLBACK CALLED ***` - –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–∞—Ü—é—é—Ç—å! ‚úÖ**

---

### 6Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Home Assistant

**–ß–µ—Ä–µ–∑ 10-30 —Å–µ–∫—É–Ω–¥ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É ESP32:**

1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å: **Settings** ‚Üí **Devices & Services** ‚Üí **MQTT**
2. –ú–∞—î –∑'—è–≤–∏—Ç–∏—Å—è –Ω–æ–≤–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π **"Bluetti EB3A"** (–≤—ñ–¥ ESP32)
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ entity:
   - `sensor.bluetti_eb3a_battery` - —Ä—ñ–≤–µ–Ω—å –±–∞—Ç–∞—Ä–µ—ó
   - `sensor.bluetti_eb3a_ac_power` - AC –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å
   - `switch.bluetti_eb3a_ac_output` - AC –≤–∏—Ö—ñ–¥
   - `switch.bluetti_eb3a_dc_output` - DC –≤–∏—Ö—ñ–¥

**–Ø–∫—â–æ entity –Ω–µ –∑'—è–≤–ª—è—é—Ç—å—Å—è:**

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ MQTT Discovery:
   - **Developer Tools** ‚Üí **MQTT**
   - –ü—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞: `homeassistant/sensor/bluetti_eb3a/+/config`
   - –ú–∞—é—Ç—å –∑'—è–≤–∏—Ç–∏—Å—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å Home Assistant:
   - **Settings** ‚Üí **System** ‚Üí **Restart**

3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ ESP32:
   - –ú–∞—î –±—É—Ç–∏: `Published discovery to MQTT`

---

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: ESP32 –Ω–µ –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ Bluetti

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ:**
1. ‚úÖ –ê–¥–¥–æ–Ω "Bluetti to MQTT" –≤–∏–º–∫–Ω–µ–Ω–∏–π?
2. ‚úÖ Bluetti —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π —ñ Bluetooth –∞–∫—Ç–∏–≤–Ω–∏–π?
3. ‚úÖ MAC –∞–¥—Ä–µ—Å–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö ESP32?
4. ‚úÖ ESP32 —ñ Bluetti –±–ª–∏–∑—å–∫–æ –æ–¥–∏–Ω –¥–æ –æ–¥–Ω–æ–≥–æ?

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å Bluetti (–≤–∏–º–∫–Ω—ñ—Ç—å —ñ —É–≤—ñ–º–∫–Ω—ñ—Ç—å)
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å ESP32
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ ESP32

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ù–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ ESP32:**
```
[Bluetti] subscribe() returned: true  ‚Üê –ü—ñ–¥–ø–∏—Å–∫–∞ —É—Å–ø—ñ—à–Ω–∞?
[Bluetti] *** CALLBACK CALLED ***     ‚Üê Callback –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è?
```

**–Ø–∫—â–æ –ø—ñ–¥–ø–∏—Å–∫–∞ —É—Å–ø—ñ—à–Ω–∞, –∞–ª–µ callback –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –∞–¥–¥–æ–Ω –¥—ñ–π—Å–Ω–æ –≤–∏–º–∫–Ω–µ–Ω–∏–π
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å Bluetti
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å ESP32

---

### –ü—Ä–æ–±–ª–µ–º–∞: Home Assistant –Ω–µ –±–∞—á–∏—Ç—å –ø—Ä–∏—Å—Ç—Ä–æ—ó

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ:**
1. ‚úÖ MQTT Discovery —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π –≤ Home Assistant?
2. ‚úÖ ESP32 –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –¥–æ MQTT?
3. ‚úÖ ESP32 –ø—É–±–ª—ñ–∫—É—î Discovery –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ `configuration.yaml`:
   ```yaml
   mqtt:
     discovery: true
   ```

2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å Home Assistant

3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ MQTT —Ç–æ–ø—ñ–∫–∏:
   - **Developer Tools** ‚Üí **MQTT**
   - –ü—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞: `homeassistant/sensor/bluetti_eb3a/+/config`

---

## ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è

**–í—Å–µ –ø—Ä–∞—Ü—é—î, —è–∫—â–æ:**

1. ‚úÖ –í –ª–æ–≥–∞—Ö ESP32 –∑'—è–≤–ª—è—î—Ç—å—Å—è `*** CALLBACK CALLED ***`
2. ‚úÖ –í Home Assistant –∑'—è–≤–∏–ª–∏—Å—è –Ω–æ–≤—ñ entity –≤—ñ–¥ ESP32
3. ‚úÖ –î–∞–Ω—ñ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è (–±–∞—Ç–∞—Ä–µ—è, –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å —Ç–æ—â–æ)
4. ‚úÖ –ö–æ–º–∞–Ω–¥–∏ –ø—Ä–∞—Ü—é—é—Ç—å (—É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è AC/DC)

---

## üìù –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å ESP32

**–Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:**

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ `http://<IP_ESP32>` –≤ –±—Ä–∞—É–∑–µ—Ä—ñ
2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ —Ä–æ–∑–¥—ñ–ª –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
3. –ó–º—ñ–Ω—ñ—Ç—å:
   - MQTT Server
   - Bluetti MAC
   - WiFi SSID/Password
4. –ó–±–µ—Ä–µ–∂—ñ—Ç—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
5. ESP32 –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è:

- ‚úÖ ESP32 –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –¥–æ Bluetti —á–µ—Ä–µ–∑ BLE
- ‚úÖ ESP32 –æ—Ç—Ä–∏–º—É—î –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤—ñ–¥ Bluetti
- ‚úÖ ESP32 –ø—É–±–ª—ñ–∫—É—î –¥–∞–Ω—ñ –≤ MQTT
- ‚úÖ Home Assistant –±–∞—á–∏—Ç—å –ø—Ä–∏—Å—Ç—Ä–æ—ó —á–µ—Ä–µ–∑ MQTT Discovery
- ‚úÖ –ö–æ–º–∞–Ω–¥–∏ –ø—Ä–∞—Ü—é—é—Ç—å (AC/DC –≤–∏—Ö–æ–¥–∏)

**–ê–¥–¥–æ–Ω "Bluetti to MQTT" –±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω!** üéâ

