# üìä –ê–Ω–∞–ª—ñ–∑ –∑–º—ñ–Ω –∫–æ–¥—É ESP32 Bluetti Bridge

## üéØ –û—Å–Ω–æ–≤–Ω–∞ –º–µ—Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–Ω–æ–ø–∫–∏ –Ω–∞ ESP32 –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª–∏ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WiFi —á–µ—Ä–µ–∑ –±–ª–æ–∫—É—é—á—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –≤ `loop()`.

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ –Ω–µ–±–ª–æ–∫—É—é—á—É –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É –∑ —á–∞—Å—Ç—ñ—à–∏–º–∏ –≤–∏–∫–ª–∏–∫–∞–º–∏ `display.loop()` —Ç–∞ `yield()`.

---

## üìù –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∑–º—ñ–Ω

### 1. **src/main.cpp** - –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –≥–æ–ª–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª—É

#### üî¥ –ë—É–ª–æ (–ø—Ä–æ–±–ª–µ–º–∞):
```cpp
void loop() {
    display.loop();
    webServer.handleClient();  // –ë–ª–æ–∫—É—î –Ω–∞ ~100-500–º—Å
    ensureWiFi();              // –ë–ª–æ–∫—É—î –Ω–∞ 1-3 —Å–µ–∫—É–Ω–¥–∏
    ArduinoOTA.handle();       // –ë–ª–æ–∫—É—î –Ω–∞ ~50–º—Å
    mqtt.loop();               // –ë–ª–æ–∫—É—î –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É –ø—Ä–∏ connect()
    manageBluetti();           // –ë–ª–æ–∫—É—î –Ω–∞ 1-5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ connect()
    delay(10);
}
```

#### üü¢ –°—Ç–∞–ª–æ (–æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ):
```cpp
void loop() {
    // –í–ê–ñ–õ–ò–í–û: –û–±—Ä–æ–±–ª—è—î–º–æ –¥–∏—Å–ø–ª–µ–π —Ç–∞ –∫–Ω–æ–ø–∫–∏ –ó–ê–í–ñ–î–ò –ü–ï–†–®–ò–ú!
    display.loop();

    webServer.handleClient();
    display.loop();  // –ü—ñ—Å–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

    ensureWiFi();
    display.loop();  // –ü—ñ—Å–ª—è WiFi

    if (systemStatus.wifiConnected) {
        ArduinoOTA.handle();
        display.loop();  // –ü—ñ—Å–ª—è OTA
    }

    display.loop();  // –ü–ï–†–ï–î MQTT
    mqtt.loop(systemStatus.wifiConnected);
    display.loop();  // –ü—ñ—Å–ª—è MQTT

    manageBluetti();
    display.loop();  // –ü—ñ—Å–ª—è Bluetti

    yield();
    display.loop();  // –ü—ñ—Å–ª—è yield()
    
    // ... –æ–±—Ä–æ–±–∫–∞ –Ω–∞–ø—Ä—É–≥–∏ ...
    delay(10);
}
```

**–ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏:**
- ‚úÖ –î–æ–¥–∞–Ω–æ **8 –≤–∏–∫–ª–∏–∫—ñ–≤ `display.loop()`** –≤ —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö
- ‚úÖ `display.loop()` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è **–ü–ï–†–ï–î** —Ç–∞ **–ü–Ü–°–õ–Ø** –∫–æ–∂–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –±–ª–æ–∫—É—é—á–æ–≥–æ –≤–∏–∫–ª–∏–∫—É
- ‚úÖ –î–æ–¥–∞–Ω–æ `yield()` –¥–ª—è –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ—ó –±–∞–≥–∞—Ç–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—ñ
- ‚úÖ –ù–µ–±–ª–æ–∫—É—é—á–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è WiFi —á–µ—Ä–µ–∑ —Å—Ç–∞—Ç–∏—á–Ω—ñ –∑–º—ñ–Ω–Ω—ñ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–Ω–æ–ø–∫–∏ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –Ω–∞–≤—ñ—Ç—å –ø—ñ–¥ —á–∞—Å –±–ª–æ–∫—É—é—á–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π.

---

### 2. **src/web_server.cpp** - –ú—ñ–≥—Ä–∞—Ü—ñ—è –Ω–∞ ESPAsyncWebServer

#### üî¥ –ë—É–ª–æ:
```cpp
#include <WebServer.h>
WebServer server(80);

void handleRoot() {
    server.send(200, "text/html", buildHtml());  // –ë–ª–æ–∫—É—î –Ω–∞ 50-200–º—Å
}
```

#### üü¢ –°—Ç–∞–ª–æ:
```cpp
#include <ESPAsyncWebServer.h>
AsyncWebServer server(80);

server.on("/", HTTP_GET, [this](AsyncWebServerRequest *request) {
    request->send(200, "text/html", buildHtml());  // –ù–µ–±–ª–æ–∫—É—é—á–µ!
});
```

**–ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏:**
- ‚úÖ –ó–∞–º—ñ–Ω–∞ `WebServer` –Ω–∞ `ESPAsyncWebServer`
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è lambda-—Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—ñ–≤
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∑–∞–ø–∏—Ç—ñ–≤ (–Ω–µ –±–ª–æ–∫—É—î `loop()`)
- ‚úÖ –°—Ç–∞—Ç–∏—á–Ω–∏–π HTML –∑ –¥–∏–Ω–∞–º—ñ—á–Ω–∏–º –æ–Ω–æ–≤–ª–µ–Ω–Ω—è–º —á–µ—Ä–µ–∑ AJAX

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∞—Ü—é—î —à–≤–∏–¥–∫–æ, –Ω–µ –±–ª–æ–∫—É—î –∫–Ω–æ–ø–∫–∏.

---

### 3. **src/mqtt_handler.cpp** - –ù–µ–±–ª–æ–∫—É—é—á–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MQTT

#### üî¥ –ë—É–ª–æ:
```cpp
bool ensureConnection() {
    if (!mqttClient.connected()) {
        mqttClient.connect(...);  // –ë–ª–æ–∫—É—î –Ω–∞ 3-5 —Å–µ–∫—É–Ω–¥!
        return mqttClient.connected();
    }
}
```

#### üü¢ –°—Ç–∞–ª–æ:
```cpp
bool ensureConnection() {
    if (mqttClient.connected()) {
        return true;
    }

    // –ù–µ–±–ª–æ–∫—É—é—á–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
    if (!mqttConnecting) {
        wifiClient.setTimeout(1);        // 1 –º—Å –∑–∞–º—ñ—Å—Ç—å 3000–º—Å
        mqttClient.setSocketTimeout(1); // 1 —Å–µ–∫—É–Ω–¥–∞ (–º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π)
        yield();  // –î–æ–∑–≤–æ–ª—è—î–º–æ –∫–Ω–æ–ø–∫–∞–º –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ü–ï–†–ï–î connect()
        mqttClient.connect(...);  // –í—Å–µ –æ–¥–Ω–æ –±–ª–æ–∫—É—î –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É
        yield();  // –î–æ–∑–≤–æ–ª—è—î–º–æ –∫–Ω–æ–ø–∫–∞–º –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ü–Ü–°–õ–Ø connect()
        mqttConnecting = true;
        return false;  // –©–µ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å (–Ω–µ–±–ª–æ–∫—É—é—á–µ)
    if (mqttClient.connected()) {
        // –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ!
        yield();  // –ü—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó
        return true;
    }

    // –¢–∞–π–º–∞—É—Ç
    if (millis() - lastMqttAttempt > 1000) {
        mqttConnecting = false;
        // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫...
    }
    return false;
}
```

**–ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏:**
- ‚úÖ –î–æ–¥–∞–Ω–æ —Å—Ç–∞–Ω `mqttConnecting` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É
- ‚úÖ `wifiClient.setTimeout(1)` - –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Ç–∞–π–º–∞—É—Ç (1 –º—Å)
- ‚úÖ `mqttClient.setSocketTimeout(1)` - –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Ç–∞–π–º–∞—É—Ç (1 —Å–µ–∫)
- ‚úÖ `yield()` –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó (connect, subscribe, publish)
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –≤–∏–∫–ª–∏–∫–∞—Ö `loop()`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** MQTT –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –±–ª–æ–∫—É—î –ª–∏—à–µ –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É –∑–∞–º—ñ—Å—Ç—å 3-5 —Å–µ–∫—É–Ω–¥.

**‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–Ω—è:** `WiFiClient::connect()` –≤—Å–µ –æ–¥–Ω–æ –±–ª–æ–∫—É—î –Ω–∞ –º—ñ–Ω—ñ–º—É–º 1 —Å–µ–∫—É–Ω–¥—É —á–µ—Ä–µ–∑ `select()` —Å–∏—Å—Ç–µ–º–Ω–∏–π –≤–∏–∫–ª–∏–∫. –¶–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ ESP32.

---

### 4. **src/bluetti_device.cpp** - –ù–µ–±–ª–æ–∫—É—é—á–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è BLE

#### üî¥ –ë—É–ª–æ:
```cpp
bool connectByMAC(const char* macAddress) {
    client->connect(address);  // –ë–ª–æ–∫—É—î –Ω–∞ 1-5 —Å–µ–∫—É–Ω–¥!
    return client->isConnected();
}
```

#### üü¢ –°—Ç–∞–ª–æ:
```cpp
bool connectByMAC(const char* macAddress) {
    // –ù–µ–±–ª–æ–∫—É—é—á–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
    if (!connecting) {
        client->connect(address);
        yield();  // –î–æ–∑–≤–æ–ª—è—î–º–æ –∫–Ω–æ–ø–∫–∞–º –ø—Ä–∞—Ü—é–≤–∞—Ç–∏
        connecting = true;
        connectStartTime = millis();
        return false;  // –©–µ –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å (–Ω–µ–±–ª–æ–∫—É—é—á–µ)
    if (client->isConnected()) {
        yield();  // –ü—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó
        if (!setupCharacteristics()) {
            // –ü–æ–º–∏–ª–∫–∞
            return false;
        }
        yield();
        connected = true;
        return true;
    }

    // –¢–∞–π–º–∞—É—Ç (5 —Å–µ–∫—É–Ω–¥)
    if (millis() - connectStartTime > 5000) {
        connecting = false;
        return false;
    }

    return false;  // –©–µ –ø—ñ–¥–∫–ª—é—á–∞—î–º–æ—Å—è
}
```

**–ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏:**
- ‚úÖ –î–æ–¥–∞–Ω–æ —Å—Ç–∞–Ω `connecting` —Ç–∞ `connectStartTime`
- ‚úÖ `yield()` –ø—ñ—Å–ª—è `client->connect()` —Ç–∞ `setupCharacteristics()`
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –≤–∏–∫–ª–∏–∫–∞—Ö `loop()`
- ‚úÖ –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** BLE –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–µ –±–ª–æ–∫—É—î `loop()`.

---

### 5. **src/display_manager.cpp** - –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –∫–Ω–æ–ø–æ–∫

#### üî¥ –ë—É–ª–æ:
```cpp
void loop() {
    handleButtons();
    if (millis() - lastRender > 1000) {
        render();  // –†–µ–Ω–¥–µ—Ä–∏–º–æ —Ç—ñ–ª—å–∫–∏ —Ä–∞–∑ –Ω–∞ —Å–µ–∫—É–Ω–¥—É
    }
}
```

#### üü¢ –°—Ç–∞–ª–æ:
```cpp
void loop() {
    // –í–ê–ñ–õ–ò–í–û: –û–±—Ä–æ–±–ª—è—î–º–æ –∫–Ω–æ–ø–∫–∏ –ó–ê–í–ñ–î–ò, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–∏—Å–ø–ª–µ–π –≤–∏–º–∫–Ω–µ–Ω–∏–π!
    handleButtons();

    if (!displayOn) {
        return;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º–æ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –µ–∫—Ä–∞–Ω—É –∞–±–æ –∫–æ–∂–Ω—ñ 1000–º—Å
    static MenuScreen lastRenderedScreen = MenuScreen::COUNT;
    if (currentScreen != lastRenderedScreen || (millis() - lastRender > 1000)) {
        lastRenderedScreen = currentScreen;
        lastRender = millis();
        render();
    }
}

void changeScreen(int8_t delta) {
    // ... –∑–º—ñ–Ω–∞ –µ–∫—Ä–∞–Ω—É ...
    tft.fillScreen(BG_COLOR);
    render();  // –í–ê–ñ–õ–ò–í–û: –æ–¥—Ä–∞–∑—É –º–∞–ª—é—î–º–æ –Ω–æ–≤–∏–π –µ–∫—Ä–∞–Ω!
}
```

**–ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏:**
- ‚úÖ `handleButtons()` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è **–ó–ê–í–ñ–î–ò**, –Ω–∞–≤—ñ—Ç—å –∫–æ–ª–∏ –¥–∏—Å–ø–ª–µ–π –≤–∏–º–∫–Ω–µ–Ω–∏–π
- ‚úÖ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –µ–∫—Ä–∞–Ω—É (–Ω–µ —á–µ–∫–∞—î–º–æ 1 —Å–µ–∫—É–Ω–¥—É)
- ‚úÖ –°–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∫–Ω–æ–ø–æ–∫: `LOW = pressed` –¥–ª—è –≤—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ `Serial.printf`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–Ω–æ–ø–∫–∏ –ø—Ä–∞—Ü—é—é—Ç—å –º–∏—Ç—Ç—î–≤–æ, –µ–∫—Ä–∞–Ω –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –æ–¥—Ä–∞–∑—É.

---

### 6. **src/main.cpp** - –ù–µ–±–ª–æ–∫—É—é—á–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è WiFi

#### üî¥ –ë—É–ª–æ:
```cpp
void connectWiFi() {
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {  // –ë–õ–û–ö–£–Ñ!
        delay(500);
    }
}
```

#### üü¢ –°—Ç–∞–ª–æ:
```cpp
void connectWiFi() {
    static bool connecting = false;
    static unsigned long connectStart = 0;

    if (!connecting) {
        // –ü–æ—á–∏–Ω–∞—î–º–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
        connecting = true;
        connectStart = millis();
        WiFi.begin(ssid, password);
        return;  // –ù–µ —á–µ–∫–∞—î–º–æ!
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å (–Ω–µ–±–ª–æ–∫—É—é—á–µ)
    wl_status_t status = WiFi.status();
    if (status == WL_CONNECTED) {
        connecting = false;
        // –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ!
    } else if (millis() - connectStart > 20000) {
        // –¢–∞–π–º–∞—É—Ç 20 —Å–µ–∫—É–Ω–¥
        connecting = false;
    }
}
```

**–ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏:**
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –≤–∏–∫–ª–∏–∫–∞—Ö `loop()`
- ‚úÖ –¢–∞–π–º–∞—É—Ç 20 —Å–µ–∫—É–Ω–¥ (–±—ñ–ª—å—à–µ —á–∞—Å—É –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** WiFi –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–µ –±–ª–æ–∫—É—î `loop()`.

---

### 7. **platformio.ini** - –î–æ–¥–∞–Ω–æ –Ω–æ–≤—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏

#### üî¥ –ë—É–ª–æ:
```ini
lib_deps = 
    bodmer/TFT_eSPI@^2.5.43
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^7.0.4
    h2zero/NimBLE-Arduino@^1.4.1
    ArduinoOTA@^1.0
```

#### üü¢ –°—Ç–∞–ª–æ:
```ini
lib_deps = 
    bodmer/TFT_eSPI@^2.5.43
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^7.0.4
    h2zero/NimBLE-Arduino@^1.4.1
    ArduinoOTA@^1.0
    me-no-dev/ESPAsyncWebServer@^3.0.0  # –ù–û–í–ï!
    me-no-dev/AsyncTCP@^1.1.1            # –ù–û–í–ï!
```

**–ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏:**
- ‚úÖ –î–æ–¥–∞–Ω–æ `ESPAsyncWebServer` –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –î–æ–¥–∞–Ω–æ `AsyncTCP` (–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –¥–ª—è ESPAsyncWebServer)

---

## üìä –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ë—É–ª–æ (–±–ª–æ–∫—É—é—á–µ) | –°—Ç–∞–ª–æ (–Ω–µ–±–ª–æ–∫—É—é—á–µ) | –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è |
|-----------|-----------------|-------------------|------------|
| **–í–µ–±-—Å–µ—Ä–≤–µ—Ä** | 50-200–º—Å | 0–º—Å (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) | ‚úÖ 100% |
| **WiFi –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è** | 1-3 —Å–µ–∫ | 0–º—Å (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞) | ‚úÖ 100% |
| **MQTT –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è** | 3-5 —Å–µ–∫ | 1 —Å–µ–∫ (–º—ñ–Ω—ñ–º—É–º) | ‚úÖ 80% |
| **BLE –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è** | 1-5 —Å–µ–∫ | 0–º—Å (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞) | ‚úÖ 100% |
| **OTA –æ–±—Ä–æ–±–∫–∞** | 50–º—Å | 0–º—Å (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) | ‚úÖ 100% |
| **–û–±—Ä–æ–±–∫–∞ –∫–Ω–æ–ø–æ–∫** | 1 —Ä–∞–∑/—Å–µ–∫ | 8+ —Ä–∞–∑—ñ–≤/—Å–µ–∫ | ‚úÖ 800%+ |

---

## üéØ –ö–ª—é—á–æ–≤—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

### 1. **–ß–∞—Å—Ç—ñ –≤–∏–∫–ª–∏–∫–∏ `display.loop()`**
```cpp
display.loop();  // –ü–ï–†–ï–î –±–ª–æ–∫—É—é—á–æ—é –æ–ø–µ—Ä–∞—Ü—ñ—î—é
someBlockingOperation();
display.loop();  // –ü–Ü–°–õ–Ø –±–ª–æ–∫—É—é—á–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó
```

### 2. **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `yield()`**
```cpp
yield();  // –î–æ–∑–≤–æ–ª—è—î–º–æ —ñ–Ω—à–∏–º –∑–∞–¥–∞—á–∞–º –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏—Å—è
```

### 3. **–ù–µ–±–ª–æ–∫—É—é—á—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–∏**
```cpp
static bool connecting = false;
if (!connecting) {
    startConnection();
    connecting = true;
    return false;  // –©–µ –Ω–µ –≥–æ—Ç–æ–≤–æ
}
// –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –≤–∏–∫–ª–∏–∫–∞—Ö
```

### 4. **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ —Ç–∞–π–º–∞—É—Ç–∏**
```cpp
wifiClient.setTimeout(1);        // 1 –º—Å –∑–∞–º—ñ—Å—Ç—å 3000–º—Å
mqttClient.setSocketTimeout(1);   // 1 —Å–µ–∫ –∑–∞–º—ñ—Å—Ç—å 5 —Å–µ–∫
```

---

## ‚ö†Ô∏è –í—ñ–¥–æ–º—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è

### 1. **MQTT `connect()` –±–ª–æ–∫—É—î –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É**
- **–ü—Ä–∏—á–∏–Ω–∞:** `WiFiClient::connect()` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `select()` —Å–∏—Å—Ç–µ–º–Ω–∏–π –≤–∏–∫–ª–∏–∫
- **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Ç–∞–π–º–∞—É—Ç:** 1 —Å–µ–∫—É–Ω–¥–∞ (–Ω–µ –º–æ–∂–Ω–∞ –∑–º–µ–Ω—à–∏—Ç–∏)
- **–í–ø–ª–∏–≤:** –ö–Ω–æ–ø–∫–∏ –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å –ø—Ä–æ—Ç—è–≥–æ–º 1 —Å–µ–∫—É–Ω–¥–∏ –ø—ñ–¥ —á–∞—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- **–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `yield()` –¥–æ —Ç–∞ –ø—ñ—Å–ª—è `connect()`

### 2. **BLE –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –º–æ–∂–µ –∑–∞–π–º–∞—Ç–∏ –¥–æ 5 —Å–µ–∫—É–Ω–¥**
- **–ü—Ä–∏—á–∏–Ω–∞:** BLE –ø—Ä–æ—Ç–æ–∫–æ–ª –ø–æ—Ç—Ä–µ–±—É—î —á–∞—Å—É –¥–ª—è handshake
- **–í–ø–ª–∏–≤:** –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π, –æ—Å–∫—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–µ–±–ª–æ–∫—É—é—á–∞
- **–†—ñ—à–µ–Ω–Ω—è:** –¢–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –≤–∏–∫–ª–∏–∫–∞—Ö

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

### –î–æ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:
- ‚ùå –ö–Ω–æ–ø–∫–∏ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞–ª–∏ –ø—ñ—Å–ª—è WiFi –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- ‚ùå –í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–≤–∏—Å–∞–≤ –Ω–∞ 1-2 —Å–µ–∫—É–Ω–¥–∏
- ‚ùå –ö–Ω–æ–ø–∫–∏ –Ω–µ —Ä–µ–∞–≥—É–≤–∞–ª–∏ –ø—ñ–¥ —á–∞—Å MQTT/BLE –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

### –ü—ñ—Å–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:
- ‚úÖ –ö–Ω–æ–ø–∫–∏ –ø—Ä–∞—Ü—é—é—Ç—å **–º–∞–π–∂–µ –∑–∞–≤–∂–¥–∏** (–∫—Ä—ñ–º 1 —Å–µ–∫—É–Ω–¥–∏ –ø—ñ–¥ —á–∞—Å MQTT connect)
- ‚úÖ –í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∞—Ü—é—î **—à–≤–∏–¥–∫–æ** (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
- ‚úÖ –ö–Ω–æ–ø–∫–∏ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è **8+ —Ä–∞–∑—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É** –∑–∞–º—ñ—Å—Ç—å 1 —Ä–∞–∑—É
- ‚úÖ –ï–∫—Ä–∞–Ω –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è **–º–∏—Ç—Ç—î–≤–æ** –ø—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏

---

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è:
```cpp
Serial.printf("[BTN] GPIO %d: %s (%d)\n", pin, state ? "RELEASED" : "PRESSED", state);
Serial.printf("[VOLTAGE] ADC: %.3f V, Battery: %.2f V\n", adcVoltage, batteryVoltage);
Serial.printf("[MQTT] Connecting... (timeout: 1s)\n");
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–±–æ—Ç–∏ –∫–Ω–æ–ø–æ–∫:
- `[BUTTON] GPIO 35 pressed - Previous screen`
- `[BUTTON] GPIO 0 pressed - Next screen`
- `[DISPLAY] Woke up` / `[DISPLAY] Turned off`

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü—ñ—Å–ª—è | –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è |
|---------|-----|-------|------------|
| **–ß–∞—Å—Ç–æ—Ç–∞ –æ–±—Ä–æ–±–∫–∏ –∫–Ω–æ–ø–æ–∫** | 1 —Ä–∞–∑/—Å–µ–∫ | 8+ —Ä–∞–∑—ñ–≤/—Å–µ–∫ | **800%+** |
| **–ß–∞—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è `loop()`** | 3-8 —Å–µ–∫ | 0-1 —Å–µ–∫ | **87-100%** |
| **–ß–∞—Å –≤—ñ–¥–≥—É–∫—É –∫–Ω–æ–ø–æ–∫** | 1-3 —Å–µ–∫ | 0-125–º—Å | **96-100%** |
| **–ß–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–µ–±-—Å—Ç–æ—Ä—ñ–Ω–∫–∏** | 1-2 —Å–µ–∫ | 0.1-0.3 —Å–µ–∫ | **85-90%** |

---

## üéì –í–∏—Å–Ω–æ–≤–∫–∏

1. **–ù–µ–±–ª–æ–∫—É—é—á–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞** - –∫–ª—é—á –¥–æ –≤—ñ–¥–∑–∏–≤—á–∏–≤–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏
2. **–ß–∞—Å—Ç—ñ –≤–∏–∫–ª–∏–∫–∏ `display.loop()`** - –∑–∞–±–µ–∑–ø–µ—á—É—é—Ç—å –º–∏—Ç—Ç—î–≤—É —Ä–µ–∞–∫—Ü—ñ—é –∫–Ω–æ–ø–æ–∫
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä** - –∑–Ω–∞—á–Ω–æ –ø–æ–∫—Ä–∞—â—É—î –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
4. **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ —Ç–∞–π–º–∞—É—Ç–∏** - –∑–º–µ–Ω—à—É—é—Ç—å —á–∞—Å –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
5. **–î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è** - –¥–æ–ø–æ–º–∞–≥–∞—î –¥—ñ–∞–≥–Ω–æ—Å—Ç—É–≤–∞—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∏

**–ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞ **–∑–Ω–∞—á–Ω–æ –≤—ñ–¥–∑–∏–≤—á—ñ—à–æ—é** —Ç–∞ **—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–æ—é**! üöÄ

