# Проблема з нотифікаціями Bluetti EB3A

## Статус проблеми

**Проблема:** Підписка на нотифікації успішна (`subscribe() returned: true`), але callback не викликається - Bluetti не відправляє нотифікації.

**⚠️ ВАЖЛИВО: КРИТИЧНА ПРОБЛЕМА ЗНАЙДЕНА!**

**Аддон "Bluetti to MQTT" в Home Assistant конфліктує з ESP32!**

Bluetti EB3A підтримує лише **ОДНЕ активне BLE підключення** одночасно. Якщо аддон "Bluetti to MQTT" працює і підключений до Bluetti, ESP32 **НЕ ЗМОЖЕ** отримувати нотифікації, навіть якщо підписка успішна.

**РІШЕННЯ:** ВИМКНІТЬ аддон "Bluetti to MQTT" перед тестуванням ESP32!

## Що перевірено

1. ✅ Підписка успішна (`subscribe() returned: true`)
2. ✅ Команди відправляються успішно
3. ✅ UUID правильні (`0000ff00-0000-1000-8000-00805f9b34fb`, `0000ff01-0000-1000-8000-00805f9b34fb`, `0000ff02-0000-1000-8000-00805f9b34fb`)
4. ✅ Instance встановлено правильно
5. ✅ Callback функція зареєстрована правильно
6. ✅ Bluetooth активний на Bluetti (пристрій увімкнено)
7. ❌ **ЗНАЙДЕНО КОНФЛІКТ:** Аддон "Bluetti to MQTT" працює і підключений до Bluetti!
8. ❌ Callback не викликається (`*** CALLBACK CALLED ***` не з'являється)

## Спробовані рішення

1. Команда перед підпискою - не допомогло
2. Команда після підписки - не допомогло
3. Різні варіанти write (з response і без) - не допомогло
4. Різні затримки - не допомогло
5. Повторні спроби підписки - не допомогло
6. Різні варіанти підписки - не допомогло
7. Явне встановлення descriptor (0x2902) перед підпискою - не допомогло
8. Перевірка значення descriptor після встановлення - додано
9. Різні команди ініціалізації (AA 55 90 EB, 01 03 00 00 00 00) - додано
10. Спроба підписки на indications замість notifications - додано

## Можливі причини

1. **⚠️ КОНФЛІКТ З АДДОНОМ "Bluetti to MQTT"** - **НАЙБІЛЬШ ЙМОВІРНА ПРИЧИНА!**
   - Аддон "Bluetti to MQTT" підключений до Bluetti (D1:4C:11:6B:6A:3D)
   - Bluetti EB3A підтримує лише одне активне BLE підключення
   - ESP32 не може отримувати нотифікації, поки аддон активний
   - **РІШЕННЯ:** Вимкнути аддон перед тестуванням ESP32
2. **Bluetti EB3A не відправляє нотифікації через BLE** - можлива особливість прошивки
3. **Потрібна інша команда для активації нотифікацій** - невідома команда
4. **Потрібна інша бібліотека** - можливо, стандартна `BLEDevice` замість `NimBLE-Arduino`
5. **Потрібна інша послідовність команд** - невідома послідовність

## Рекомендації для подальшого дослідження

1. **Перевірити інші проекти** - подивитися, як вони працюють з Bluetti EB3A
2. **Спробувати іншу бібліотеку** - стандартна `BLEDevice` замість `NimBLE-Arduino`
3. **Перевірити прошивку Bluetti** - оновити до останньої версії
4. **Перевірити, чи працювало це раніше** - якщо так, можливо, щось змінилося

## Альтернативні підходи

1. **Використати polling замість нотифікацій** - періодично читати дані (але `canRead: NO`)
2. **Використати іншу бібліотеку** - стандартна `BLEDevice` замість `NimBLE-Arduino`
3. **Використати інший протокол** - можливо, потрібен інший підхід

## Додаткова інформація з інтернету

### Рекомендації з спільноти

1. **Оновлення прошивки Bluetti EB3A**
   - Оновіть прошивку до останньої версії через офіційний додаток BLUETTI
   - Застаріла прошивка може мати проблеми з BLE нотифікаціями
   - Документація: https://uk.manuals.plus/bluetti/eb3a-bluetti-eu-portable-power-station-manual

2. **Альтернативні бібліотеки BLE**
   - Спробуйте стандартну бібліотеку `BLEDevice` замість `NimBLE-Arduino`
   - Деякі користувачі повідомляють про кращу сумісність з різними пристроями
   - Різні бібліотеки можуть мати різну реалізацію підписки на нотифікації

3. **Перевірка стану Bluetooth на Bluetti**
   - Переконайтеся, що Bluetooth активний (увімкніть AC/DC вихід)
   - Деякі моделі вимикають Bluetooth при низькому заряді або після тривалого простою
   - Спільнота: https://community.bluettipower.com/t/bluetooth-not-pairing/3963

4. **Перевірка підключень**
   - Переконайтеся, що Bluetti не підключений до іншого пристрою
   - Деякі пристрої підтримують лише одне активне підключення через BLE
   - Спільнота: https://community.bluettipower.com/t/eb3a-no-bluetooth-connection-anymore/27362

5. **Альтернативні підходи**
   - Розгляньте можливість періодичного читання (polling) характеристик замість підписки
   - Це може бути менш ефективним, але забезпечить отримання даних
   - **ПРОБЛЕМА:** `canRead: NO` - характеристика не підтримує читання

6. **Звернення до спільноти**
   - Спільнота Bluetti: https://community.bluettipower.com/
   - Проект SmokyBob: https://github.com/SmokyBob/Bluetti_ESP32
   - Можливо, інші розробники стикалися з подібною проблемою

### Відомі проблеми з Bluetti EB3A

- Деякі користувачі повідомляють про проблеми з вимкненням при певному рівні заряду
- Проблеми з зарядкою в деяких випадках
- Проблеми з Bluetooth після тривалого простою
- Спільнота: https://community.bluettipower.com/t/eb3a-shutting-down-at-42-not-in-eco-mode/30012

## Висновок

**⚠️ ПРОБЛЕМА ПІДТВЕРДЖЕНА - НОТИФІКАЦІЇ НЕ ПРАЦЮЮТЬ!**

Після всіх спроб (вимкнення аддону, перезапуску Bluetti, різних команд, перевірки descriptor) проблема залишається:
- ✅ Підключення успішне
- ✅ Підписка успішна (`subscribe() returned: true`)
- ✅ Descriptor встановлено правильно (`01 00`)
- ✅ Команди відправляються успішно
- ❌ Callback **НЕ ВИКЛИКАЄТЬСЯ** - `*** CALLBACK CALLED ***` не з'являється
- ❌ Bluetti **НЕ ВІДПРАВЛЯЄ** нотифікації

**Фінальний висновок:** Прошивка Bluetti EB3A **не підтримує автоматичні нотифікації через BLE**, навіть якщо підписка технічно успішна. Це обмеження прошивки Bluetti EB3A.

### Найбільш ймовірні рішення (в порядку пріоритету):

1. **⚠️ ВИМКНУТИ АДДОН "Bluetti to MQTT"** - **ВИКОНАНО! ✅**
   - Аддон вимкнено, але проблема залишається
   
2. **Спробувати стандартну бібліотеку `BLEDevice`** замість `NimBLE-Arduino`
   - Це вимагає повного рефакторингу коду
   - Можливо, стандартна бібліотека краще працює з Bluetti EB3A
   - **ВАЖЛИВО:** Це велика зміна, яка може зайняти багато часу
   
3. **Реалізувати polling замість нотифікацій**
   - Проблема: `canRead: NO` - характеристика не підтримує читання
   - Можливо, потрібен інший підхід до отримання даних
   
4. **Оновити прошивку Bluetti EB3A** до останньої версії
   - Можливо, нова прошивка підтримує нотифікації
   
5. **Звернутися до спільноти Bluetti** для отримання допомоги
   - Можливо, інші користувачі стикалися з подібною проблемою
   - Спільнота: https://community.bluettipower.com/
   
6. **Перевірити інші проекти** (SmokyBob/Bluetti_ESP32) для порівняння реалізації
   - Можливо, там використовується інший підхід

### Інструкція для тестування:

1. **Вимкніть аддон "Bluetti to MQTT"** в Home Assistant
2. **Перезапустіть ESP32** (або просто дочекайтеся перепідключення)
3. **Перевірте логи ESP32** - має з'явитися `*** CALLBACK CALLED ***`
4. Якщо нотифікації працюють - проблема вирішена!
5. Якщо ні - продовжуйте з іншими рішеннями вище

