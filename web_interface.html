<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    <title>ESP32 Monitor</title>
    <style>
        body{font-family:Arial;margin:0;padding:12px;background:#f5f5f5;}
        .c{max-width:800px;margin:0 auto;}
        .card{background:#fff;padding:16px;border-radius:8px;margin-bottom:12px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
        h1{font-size:20px;margin:0 0 12px 0;color:#333;}
        h2{font-size:16px;margin:0 0 8px 0;color:#555;border-bottom:1px solid #eee;padding-bottom:6px;}
        .g{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-top:8px;}
        .i{display:flex;justify-content:space-between;padding:6px;background:#f9f9f9;border-radius:4px;align-items:center;}
        .l{font-weight:bold;color:#666;font-size:13px;}
        .v{color:#333;font-size:13px;}
        .b{display:inline-block;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:bold;}
        .bs{background:#d4edda;color:#155724;}
        .bd{background:#f8d7da;color:#721c24;}
        .bw{background:#fff3cd;color:#856404;}
        button{width:100%;padding:10px;border:none;border-radius:6px;font-size:14px;margin-top:8px;cursor:pointer;font-weight:bold;}
        .btn-s{background:#28a745;color:#fff;}
        .btn-d{background:#dc3545;color:#fff;}
        .btn-sm{background:#2196F3;color:#fff;padding:4px 8px;font-size:11px;width:auto;margin:0 0 0 8px;}
        .btn-w{background:#ffc107;color:#000;}
        .btn-eco{background:#4CAF50;color:#fff;padding:8px;margin-top:4px;}
        .btn-power{background:#F44336;color:#fff;padding:8px;margin-top:4px;}
        button:hover{opacity:0.9;}
        select{padding:4px 8px;font-size:11px;border-radius:4px;margin-left:8px;}
    </style>
    <script>
        function u(){
            fetch('/status').then(r=>r.json()).then(d=>{
                // WiFi & System
                document.getElementById('ws').textContent=d.wifi_connected?'–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ':'–í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                document.getElementById('wi').textContent=d.wifi_ip||'0.0.0.0';
                document.getElementById('wr').textContent=d.wifi_rssi+' dBm';
                document.getElementById('ms').textContent=d.mqtt_connected?'–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ':'–û—á—ñ–∫—É–≤–∞–Ω–Ω—è';
                var h=Math.floor(d.uptime/3600),m=Math.floor((d.uptime%3600)/60),s=d.uptime%60;
                document.getElementById('ut').textContent=h+':'+(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
                
                // ESP32 Battery
                var v=d.battery_voltage||0,p=d.battery_percent||0;
                if(d.usb_powered){
                    if(v>0.1)document.getElementById('eb').innerHTML=v.toFixed(2)+' V ('+p+'%) <span style="color:#4CAF50;">USB</span>';
                    else document.getElementById('eb').innerHTML='USB Powered';
                }else if(v<0.05)document.getElementById('eb').textContent=v.toFixed(2)+' V';
                else if(v>=2.5)document.getElementById('eb').textContent=v.toFixed(2)+' V ('+p+'%)';
                else document.getElementById('eb').textContent=v.toFixed(2)+' V';
                
                // Bluetti Battery
                document.getElementById('bl').textContent=d.battery_level+'%';
                
                // AC/DC Output
                var acText=(d.ac_state?'ON':'OFF')+' '+d.ac_power+'W';
                if(d.ac_input_power>d.ac_power+5)acText+=' (‚ö°'+d.ac_input_power+'W)';
                else if(d.ac_state&&d.ac_input_power<=5&&d.ac_power>5)acText+=' (üîåUPS)';
                document.getElementById('ac').textContent=acText;
                
                var dcText=(d.dc_state?'ON':'OFF')+' '+d.dc_power+'W';
                if(d.dc_input_power>d.dc_power+5)dcText+=' (‚ö°'+d.dc_input_power+'W)';
                document.getElementById('dc').textContent=dcText;
                
                var inputText=d.input_power+'W';
                if(d.ac_state&&d.ac_input_power<=5&&d.ac_power>5)inputText+=' (UPS —Ä–µ–∂–∏–º)';
                document.getElementById('ip').textContent=inputText;
                
                // Charging Speed
                document.getElementById('cs-text').textContent=d.charging_speed==0?'Standard':(d.charging_speed==1?'Silent':'Turbo');
                
                // ECO Mode
                document.getElementById('eco-text').textContent=d.eco_mode?'ON':'OFF';
                
                // Power Lifting
                document.getElementById('pl-text').textContent=d.power_lifting?'ON':'OFF';
                
                // LED Mode
                var ledText=['','Low','High','SOS','Off'];
                document.getElementById('led-text').textContent=ledText[d.led_mode]||'Off';
                
                // ECO Shutdown
                document.getElementById('ecs-text').textContent=d.eco_shutdown+'h';
                
                // ESP32 Memory
                document.getElementById('fh').textContent=Math.floor(d.free_heap/1024)+' KB';
                document.getElementById('th').textContent=Math.floor(d.total_heap/1024)+' KB';
                document.getElementById('mh').textContent=Math.floor(d.max_heap/1024)+' KB';
                document.getElementById('cf').textContent=d.cpu_freq+' MHz';
                
                // Dynamic buttons (AC/DC/Charging)
                var acContainer=document.getElementById('acb-container');
                if(acContainer){
                    if(d.bluetti_connected){
                        if(!document.getElementById('acb')){
                            var acBtn=document.createElement('button');
                            acBtn.id='acb';
                            acBtn.className='btn-sm';
                            acBtn.onclick=function(){
                                fetch('/ac_output',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'state='+(d.ac_state?'off':'on')}).then(()=>setTimeout(u,1000));
                            };
                            acContainer.appendChild(acBtn);
                        }
                        var ac=document.getElementById('acb');
                        if(ac)ac.textContent=d.ac_state?'üî¥ –í–∏–º–∫':'üü¢ –£–≤—ñ–º–∫';
                    }else{acContainer.innerHTML='';}
                }
                
                var dcContainer=document.getElementById('dcb-container');
                if(dcContainer){
                    if(d.bluetti_connected){
                        if(!document.getElementById('dcb')){
                            var dcBtn=document.createElement('button');
                            dcBtn.id='dcb';
                            dcBtn.className='btn-sm';
                            dcBtn.onclick=function(){
                                fetch('/dc_output',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'state='+(d.dc_state?'off':'on')}).then(()=>setTimeout(u,1000));
                            };
                            dcContainer.appendChild(dcBtn);
                        }
                        var dc=document.getElementById('dcb');
                        if(dc)dc.textContent=d.dc_state?'üî¥ –í–∏–º–∫':'üü¢ –£–≤—ñ–º–∫';
                    }else{dcContainer.innerHTML='';}
                }
                
                var csContainer=document.getElementById('cs-container');
                if(csContainer){
                    if(d.bluetti_connected){
                        if(!document.getElementById('cs')){
                            var csBtn=document.createElement('button');
                            csBtn.id='cs';
                            csBtn.className='btn-sm';
                            csBtn.onclick=function(){
                                var next=d.charging_speed==0?1:(d.charging_speed==1?2:0);
                                fetch('/charging_speed',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'speed='+next}).then(()=>setTimeout(u,1000));
                            };
                            csContainer.appendChild(csBtn);
                        }
                        var cs=document.getElementById('cs');
                        if(cs)cs.textContent=d.charging_speed==0?'üìä Standard':(d.charging_speed==1?'üîá Silent':'‚ö° Turbo');
                    }else{csContainer.innerHTML='';}
                }
                
                // Status buttons
                var btn=document.getElementById('toggleBtn');
                if(btn){
                    btn.textContent=d.bluetti_enabled?'üî¥ –í–∏–º–∫–Ω—É—Ç–∏':'üü¢ –£–≤—ñ–º–∫–Ω—É—Ç–∏';
                    btn.className=d.bluetti_enabled?'btn-d':'btn-s';
                }
                var bs=document.getElementById('bs');
                if(bs)bs.textContent=d.bluetti_connected?'–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ':(d.bluetti_enabled?'–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...':'–í–∏–º–∫–Ω–µ–Ω–æ');
                
                // Show/hide new feature controls
                var ecoBtn=document.getElementById('eco-btn');
                var plBtn=document.getElementById('pl-btn');
                var ledSelect=document.getElementById('led-select');
                var ecsSelect=document.getElementById('ecs-select');
                var powerBtn=document.getElementById('power-btn');
                
                if(d.bluetti_connected){
                    if(ecoBtn){
                        ecoBtn.style.display='block';
                        ecoBtn.textContent=d.eco_mode?'üåø ECO: ON':'üåø ECO: OFF';
                        ecoBtn.onclick=function(){
                            fetch('/eco_mode',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'state='+(d.eco_mode?'off':'on')}).then(()=>setTimeout(u,1000));
                        };
                    }
                    if(plBtn){
                        plBtn.style.display='block';
                        plBtn.textContent=d.power_lifting?'‚ö° Power Lifting: ON':'‚ö° Power Lifting: OFF';
                        plBtn.onclick=function(){
                            fetch('/power_lifting',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'state='+(d.power_lifting?'off':'on')}).then(()=>setTimeout(u,1000));
                        };
                    }
                    if(ledSelect){
                        ledSelect.style.display='inline-block';
                        ledSelect.value=d.led_mode||4;
                        ledSelect.onchange=function(){
                            fetch('/led_mode',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'mode='+ledSelect.value}).then(()=>setTimeout(u,1000));
                        };
                    }
                    if(ecsSelect){
                        ecsSelect.style.display='inline-block';
                        ecsSelect.value=d.eco_shutdown||1;
                        ecsSelect.onchange=function(){
                            fetch('/eco_shutdown',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'hours='+ecsSelect.value}).then(()=>setTimeout(u,1000));
                        };
                    }
                    if(powerBtn)powerBtn.style.display='block';
                }else{
                    if(ecoBtn)ecoBtn.style.display='none';
                    if(plBtn)plBtn.style.display='none';
                    if(ledSelect)ledSelect.style.display='none';
                    if(ecsSelect)ecsSelect.style.display='none';
                    if(powerBtn)powerBtn.style.display='none';
                }
            }).catch(e=>console.error('E:',e));
        }
        setInterval(u,3000);
        u();
    </script>
</head>
<body>
    <div class='c'>
        <div class='card'>
            <h1>üîã ESP32 Monitor</h1>
        </div>
        
        <div class='card'>
            <h2>üì° –°–∏—Å—Ç–µ–º–∞</h2>
            <div class='g'>
                <div class='i'><span class='l'>WiFi:</span><span class='b bs'><span id='ws'>...</span></span></div>
                <div class='i'><span class='l'>IP:</span><span class='v' id='wi'>...</span></div>
                <div class='i'><span class='l'>RSSI:</span><span class='v' id='wr'>...</span></div>
                <div class='i'><span class='l'>MQTT:</span><span class='b bw'><span id='ms'>...</span></span></div>
                <div class='i'><span class='l'>Uptime:</span><span class='v' id='ut'>...</span></div>
                <div class='i'><span class='l'>–ë–∞—Ç–∞—Ä–µ—è:</span><span class='v' id='eb'>...</span></div>
            </div>
        </div>
        
        <div class='card'>
            <h2>üíª ESP32</h2>
            <div class='g'>
                <div class='i'><span class='l'>–í—ñ–ª—å–Ω–∞:</span><span class='v' id='fh'>...</span></div>
                <div class='i'><span class='l'>–ó–∞–≥–∞–ª—å–Ω–∞:</span><span class='v' id='th'>...</span></div>
                <div class='i'><span class='l'>–ú–∞–∫—Å:</span><span class='v' id='mh'>...</span></div>
                <div class='i'><span class='l'>CPU:</span><span class='v' id='cf'>...</span></div>
            </div>
        </div>
        
        <div class='card'>
            <h2>üîã Bluetti</h2>
            <div class='i'><span class='l'>–°—Ç–∞—Ç—É—Å:</span><span class='b bw'><span id='bs'>...</span></span></div>
            <div class='g'>
                <div class='i'><span class='l'>–ë–∞—Ç–∞—Ä–µ—è:</span><span class='v' id='bl'>...</span></div>
                <div class='i'><span class='l'>AC:</span><span class='v' id='ac'>...</span><span id='acb-container'></span></div>
                <div class='i'><span class='l'>DC:</span><span class='v' id='dc'>...</span><span id='dcb-container'></span></div>
                <div class='i'><span class='l'>–í—Ö—ñ–¥:</span><span class='v' id='ip'>...</span></div>
                <div class='i'><span class='l'>–ó–∞—Ä—è–¥–∫–∞:</span><span class='v' id='cs-text'>...</span><span id='cs-container'></span></div>
                <div class='i'><span class='l'>ECO:</span><span class='v' id='eco-text'>...</span></div>
                <div class='i'><span class='l'>Power Lift:</span><span class='v' id='pl-text'>...</span></div>
                <div class='i'><span class='l'>LED:</span><span class='v' id='led-text'>...</span><select id='led-select' style='display:none;'><option value='1'>Low</option><option value='2'>High</option><option value='3'>SOS</option><option value='4'>Off</option></select></div>
                <div class='i'><span class='l'>ECO –¢–∞–π–º–µ—Ä:</span><span class='v' id='ecs-text'>...</span><select id='ecs-select' style='display:none;'><option value='1'>1h</option><option value='2'>2h</option><option value='3'>3h</option><option value='4'>4h</option></select></div>
            </div>
            <button id='eco-btn' class='btn-eco' style='display:none;'>üåø ECO Mode</button>
            <button id='pl-btn' class='btn-eco' style='display:none;'>‚ö° Power Lifting</button>
            <button id='power-btn' class='btn-power' style='display:none;' onclick="if(confirm('–í–∏–º–∫–Ω—É—Ç–∏ Bluetti?'))fetch('/power_off',{method:'POST'}).then(()=>alert('Bluetti –≤–∏–º–∫–Ω–µ–Ω–æ'));">üî¥ Power Off</button>
            <button id='toggleBtn' class='btn-s' onclick="location.href='/toggle'">–£–≤—ñ–º–∫–Ω—É—Ç–∏</button>
        </div>
        
        <div class='card'>
            <button class='btn-w' onclick="location.href='/config'">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            <button class='btn-w' onclick="location.href='/update'">üì§ –ü—Ä–æ—à–∏–≤–∫–∞</button>
            <button class='btn-w' onclick="if(confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏?'))location.href='/restart'">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        </div>
    </div>
</body>
</html>
