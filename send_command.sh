#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –≤ ESP32 —á–µ—Ä–µ–∑ Serial
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./send_command.sh [–∫–æ–º–∞–Ω–¥–∞]
# –ü—Ä–∏–∫–ª–∞–¥: ./send_command.sh resetwifi

if [ -z "$1" ]; then
    echo "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: $0 [–∫–æ–º–∞–Ω–¥–∞]"
    echo ""
    echo "–î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
    echo "  resetwifi    - –°–∫–∏–Ω—É—Ç–∏ WiFi –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è"
    echo "  ap           - –ó–∞–ø—É—Å—Ç–∏—Ç–∏ AP —Ä–µ–∂–∏–º"
    echo "  status       - –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å"
    echo "  help         - –ü–æ–∫–∞–∑–∞—Ç–∏ –¥–æ–ø–æ–º–æ–≥—É"
    echo ""
    echo "–ü—Ä–∏–∫–ª–∞–¥: $0 resetwifi"
    exit 1
fi

# –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–æ—Ä—Ç
PORT=$(pio device list | grep -oP '/dev/tty(ACM|USB)\d+' | head -1)

if [ -z "$PORT" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ ESP32 –ø—Ä–∏—Å—Ç—Ä—ñ–π!"
    echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è USB –∫–∞–±–µ–ª—é."
    exit 1
fi

echo "üì° –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥–∏ '$1' –Ω–∞ $PORT..."
echo ""

# –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –ø–æ—Ä—Ç
stty -F "$PORT" 115200 cs8 -cstopb -parenb raw -echo

# –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–º–∞–Ω–¥—É
echo -e "$1\r\n" > "$PORT"

# –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞
sleep 0.1

echo "‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞!"
echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Serial Monitor –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è."
echo ""
echo "üí° –î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ:"
echo "   pio device monitor --baud 115200"

